{"version":3,"sources":["../src/mcpClient.ts","../src/mcpTool.ts","../src/lib/mcpUri.ts","../src/lib/slugify.ts","../src/mcpToolManager.ts","../src/mcpSession.ts"],"names":["capabilities"],"mappings":"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","sourcesContent":["import { MetorialSDK } from '@metorial/core';\nimport { Client } from '@modelcontextprotocol/sdk/client/index.js';\nimport { SSEClientTransport } from '@modelcontextprotocol/sdk/client/sse.js';\nimport { RequestOptions } from '@modelcontextprotocol/sdk/shared/protocol.js';\nimport {\n  CallToolRequest,\n  CallToolResult,\n  CallToolResultSchema,\n  ClientCapabilities,\n  CompatibilityCallToolResultSchema,\n  CompleteRequest,\n  CompleteResult,\n  GetPromptRequest,\n  GetPromptResult,\n  ListPromptsRequest,\n  ListPromptsResult,\n  ListResourcesRequest,\n  ListResourcesResult,\n  ListResourceTemplatesRequest,\n  ListResourceTemplatesResult,\n  ListToolsRequest,\n  ListToolsResult,\n  LoggingLevel,\n  ReadResourceRequest,\n  ReadResourceResult,\n  SetLevelRequest\n} from '@modelcontextprotocol/sdk/types.js';\n\nexport class MetorialMcpClient {\n  private constructor(private readonly client: Client) {}\n\n  static async create(\n    session: MetorialSDK.Session,\n    opts: {\n      host: string;\n      deploymentId: string;\n      clientName?: string;\n      clientVersion?: string;\n    }\n  ) {\n    let client = new Client({\n      name: opts?.clientName ?? 'metorial-js-client',\n      version: opts?.clientVersion ?? '1.0.0'\n    });\n\n    let transport = new SSEClientTransport(\n      new URL(\n        `/mcp/${session.id}/${opts.deploymentId}/sse?key=${session.clientSecret.secret}`,\n        opts.host\n      )\n    );\n\n    await client.connect(transport);\n\n    return new MetorialMcpClient(client);\n  }\n\n  public registerCapabilities(capabilities: ClientCapabilities) {\n    return this.client.registerCapabilities(capabilities);\n  }\n\n  public getServerCapabilities() {\n    return this.client.getServerCapabilities()!;\n  }\n\n  public getServerVersion() {\n    return this.client.getServerVersion()!;\n  }\n\n  public getInstructions() {\n    return this.client.getInstructions();\n  }\n\n  complete(params: CompleteRequest['params'], options?: RequestOptions): Promise<CompleteResult> {\n    return this.client.complete(params, options);\n  }\n\n  setLoggingLevel(level: LoggingLevel, options?: RequestOptions): Promise<object> {\n    return this.client.setLoggingLevel(level, options);\n  }\n\n  getPrompt(params: GetPromptRequest['params'], options?: RequestOptions): Promise<GetPromptResult> {\n    return this.client.getPrompt(params, options);\n  }\n\n  listPrompts(params?: ListPromptsRequest['params'], options?: RequestOptions): Promise<ListPromptsResult> {\n    return this.client.listPrompts(params, options);\n  }\n\n  listResources(params?: ListResourcesRequest['params'], options?: RequestOptions): Promise<ListResourcesResult> {\n    return this.client.listResources(params, options);\n  }\n\n  listResourceTemplates(\n    params?: ListResourceTemplatesRequest['params'],\n    options?: RequestOptions\n  ): Promise<ListResourceTemplatesResult> {\n    return this.client.listResourceTemplates(params, options);\n  }\n\n  readResource(params: ReadResourceRequest['params'], options?: RequestOptions): Promise<ReadResourceResult> {\n    return this.client.readResource(params, options);\n  }\n\n  callTool(\n    params: CallToolRequest['params'],\n    resultSchema:\n      | typeof CallToolResultSchema\n      | typeof CompatibilityCallToolResultSchema = CallToolResultSchema,\n    options?: RequestOptions\n  ): Promise<any> {\n    return this.client.callTool(params, resultSchema, options);\n  }\n\n  listTools(params?: ListToolsRequest['params'], options?: RequestOptions): Promise<ListToolsResult> {\n    return this.client.listTools(params, options);\n  }\n\n  sendRootsListChanged() {\n    return this.client.sendRootsListChanged();\n  }\n\n  close() {\n    return this.client.close();\n  }\n}\n","import { MetorialSDK } from '@metorial/core';\nimport { JsonSchema, jsonSchemaToOpenApi } from '@metorial/json-schema';\nimport { McpUriTemplate } from './lib/mcpUri';\nimport { slugify } from './lib/slugify';\nimport { MetorialMcpSession } from './mcpSession';\n\ntype SmallServerDeployment =\n  MetorialSDK.ServerCapabilities['mcpServers'][number]['serverDeployment'];\ntype Tool = Omit<MetorialSDK.ServerCapabilities['tools'][number], 'mcpServerId'>;\ntype ResourceTemplate = Omit<\n  MetorialSDK.ServerCapabilities['resourceTemplates'][number],\n  'mcpServerId'\n>;\n\nexport type Capability =\n  | {\n      type: 'tool';\n      tool: Tool;\n      serverDeployment: SmallServerDeployment;\n    }\n  | {\n      type: 'resource-template';\n      resourceTemplate: ResourceTemplate;\n      serverDeployment: SmallServerDeployment;\n    };\n\nconst MAX_RETRIES = 10;\n\nlet runWithRetries = async <T>(\n  action: () => Promise<T>,\n  retries: number = MAX_RETRIES\n): Promise<T> => {\n  let err: Error | undefined;\n\n  for (let i = 0; i < retries; i++) {\n    try {\n      return await action();\n    } catch (error) {\n      err = error as Error;\n    }\n  }\n\n  throw err!;\n};\n\nexport class MetorialMcpTool {\n  #id: string;\n  #name: string;\n  #description: string | null;\n  #parameters: JsonSchema;\n\n  private constructor(\n    private readonly session: MetorialMcpSession,\n    opts: {\n      id: string;\n      name: string;\n      description: string | null;\n      parameters: JsonSchema;\n    },\n    private readonly action: (args: any) => Promise<any>\n  ) {\n    this.#id = opts.id;\n    this.#name = opts.name;\n    this.#description = opts.description;\n    this.#parameters = opts.parameters;\n  }\n\n  get name() {\n    return this.#name;\n  }\n\n  get id() {\n    return this.#id;\n  }\n\n  get description() {\n    return this.#description;\n  }\n\n  get parameters() {\n    return this.#parameters;\n  }\n\n  async call(args: any) {\n    return await this.action(args);\n  }\n\n  getParametersAs(as: 'json-schema' | 'openapi-3.0.0' | 'openapi-3.1.0' = 'json-schema') {\n    if (as == 'json-schema') return this.#parameters;\n\n    if (as == 'openapi-3.0.0' || as == 'openapi-3.1.0') {\n      return jsonSchemaToOpenApi(this.#parameters, {\n        openApiVersion: as == 'openapi-3.0.0' ? '3.0.0' : '3.1.0',\n        preserveJsonSchemaKeywords: false,\n        nullHandling: 'nullable'\n      });\n    }\n\n    throw new Error(`[METORIAL MCP]: Unknown parameters format: ${as}`);\n  }\n\n  static fromTool(session: MetorialMcpSession, capability: Capability) {\n    if (capability.type !== 'tool') {\n      throw new Error(\n        `[METORIAL MCP]: Expected capability type to be 'tool', got '${capability.type}'`\n      );\n    }\n\n    let { tool, serverDeployment } = capability;\n\n    return new MetorialMcpTool(\n      session,\n      {\n        id: slugify(tool.name),\n        name: tool.name,\n        description: tool.description ?? null,\n        parameters: tool.inputSchema\n      },\n      async params =>\n        runWithRetries(async () => {\n          let client = await session.getClient({\n            deploymentId: serverDeployment!.id\n          });\n\n          let result = await client.callTool({\n            name: tool.name,\n            arguments: params\n          });\n\n          return result;\n        }, MAX_RETRIES)\n    );\n  }\n\n  static fromResourceTemplate(session: MetorialMcpSession, capability: Capability) {\n    if (capability.type !== 'resource-template') {\n      throw new Error(\n        `[METORIAL MCP]: Expected capability type to be 'resource-template', got '${capability.type}'`\n      );\n    }\n\n    let { resourceTemplate, serverDeployment } = capability;\n\n    let uri = new McpUriTemplate(resourceTemplate.uriTemplate);\n\n    return new MetorialMcpTool(\n      session,\n      {\n        id: slugify(resourceTemplate.name),\n        name: resourceTemplate.name,\n        description: resourceTemplate.description ?? null,\n        parameters: {\n          type: 'object',\n          properties: Object.fromEntries(\n            uri.getProperties().map(prop => [prop.key, { type: 'string' }])\n          ),\n          required: uri\n            .getProperties()\n            .filter(prop => !prop.optional)\n            .map(prop => prop.key),\n          additionalProperties: false\n        }\n      },\n      async params =>\n        runWithRetries(async () => {\n          let client = await session.getClient({\n            deploymentId: serverDeployment!.id\n          });\n\n          let finalUri = uri.expand(params);\n\n          let result = await client.readResource({\n            uri: finalUri\n          });\n\n          return result;\n        }, MAX_RETRIES)\n    );\n  }\n\n  static fromCapability(session: MetorialMcpSession, capability: Capability): MetorialMcpTool {\n    if (capability.type === 'tool') {\n      return MetorialMcpTool.fromTool(session, capability);\n    }\n\n    if (capability.type === 'resource-template') {\n      return MetorialMcpTool.fromResourceTemplate(session, capability);\n    }\n\n    throw new Error(\n      `[METORIAL MCP]: Unknown capability type: ${capability}. Expected 'tool' or 'resource-template'.`\n    );\n  }\n}\n","type TemplateValues = Record<string, string | string[]>;\n\nexport class McpUriTemplate {\n  private segments: (string | { key: string; explode: boolean; optional: boolean })[];\n\n  constructor(private template: string) {\n    this.segments = this.parseTemplate(template);\n  }\n\n  private parseTemplate(template: string) {\n    let pattern = /\\{(\\/)?([\\w]+)(\\*)?\\}/g;\n    let match: RegExpExecArray | null;\n    let lastIndex = 0;\n    let parts: (string | { key: string; explode: boolean; optional: boolean })[] = [];\n\n    while ((match = pattern.exec(template)) !== null) {\n      let [fullMatch, leadingSlash, key, star] = match;\n      if (match.index > lastIndex) {\n        parts.push(template.slice(lastIndex, match.index));\n      }\n\n      parts.push({\n        key,\n        explode: !!star,\n        optional: !!leadingSlash\n      });\n\n      lastIndex = match.index + fullMatch.length;\n    }\n\n    if (lastIndex < template.length) {\n      parts.push(template.slice(lastIndex));\n    }\n\n    return parts;\n  }\n\n  getProperties() {\n    return this.segments.filter(part => typeof part !== 'string').map(part => part);\n  }\n\n  getKeys() {\n    return this.getProperties().map(part => part.key);\n  }\n\n  expand(values: TemplateValues) {\n    return this.segments\n      .map(segment => {\n        if (typeof segment === 'string') return segment;\n\n        let { key, explode, optional } = segment;\n        let value = values[key];\n\n        if (value === undefined || value === null) {\n          if (optional) return '';\n          throw new Error(`Missing value for required key: ${key}`);\n        }\n\n        if (Array.isArray(value)) {\n          return (optional ? '/' : '') + value.map(encodeURIComponent).join('/');\n        } else {\n          return (optional ? '/' : '') + encodeURIComponent(value);\n        }\n      })\n      .join('');\n  }\n}\n","export let slugify = (input: string): string =>\n  input\n    .toLowerCase() // Convert to lowercase\n    .trim() // Remove leading/trailing whitespace\n    .replace(/\\s+/g, '-') // Replace spaces with hyphens\n    .replace(/[^a-z0-9_-]/g, '') // Remove all characters except a-z, 0-9, _, -\n    .replace(/-+/g, '-') // Replace multiple consecutive hyphens with single hyphen\n    .replace(/^-+|-+$/g, ''); // Remove leading and trailing hyphens\n","import { MetorialMcpSession } from './mcpSession';\nimport { Capability, MetorialMcpTool } from './mcpTool';\n\nexport class MetorialMcpToolManager {\n  #tools = new Map<string, MetorialMcpTool>();\n\n  private constructor(\n    private readonly session: MetorialMcpSession,\n    tools: MetorialMcpTool[]\n  ) {\n    for (let tool of tools) {\n      this.#tools.set(tool.id, tool);\n      this.#tools.set(tool.name, tool);\n    }\n  }\n\n  static async fromCapabilities(session: MetorialMcpSession, capabilities: Capability[]) {\n    return new MetorialMcpToolManager(\n      session,\n      capabilities.map(c => MetorialMcpTool.fromCapability(session, c))\n    );\n  }\n\n  getTool(idOrName: string): MetorialMcpTool | undefined {\n    return this.#tools.get(idOrName);\n  }\n\n  getTools(): MetorialMcpTool[] {\n    return Array.from(this.#tools.values());\n  }\n\n  callTool(idOrName: string, args: any): Promise<any> {\n    let tool = this.getTool(idOrName);\n    if (!tool) throw new Error(`Tool not found: ${idOrName}`);\n    return tool.call(args);\n  }\n}\n","import { MetorialCoreSDK, MetorialSDK } from '@metorial/core';\nimport { DashboardInstanceSessionsCreateBody } from '@metorial/generated';\nimport { MetorialMcpClient } from './mcpClient';\nimport { Capability } from './mcpTool';\nimport { MetorialMcpToolManager } from './mcpToolManager';\n\nexport type MetorialMcpSessionInitServerDeployments = (DashboardInstanceSessionsCreateBody & {\n  serverDeploymentIds?: never;\n})['serverDeployments'];\n\nexport type MetorialMcpSessionInit = {\n  serverDeployments: MetorialMcpSessionInitServerDeployments;\n  client?: {\n    name?: string;\n    version?: string;\n  };\n};\n\nexport class MetorialMcpSession {\n  #sessionPromise: Promise<MetorialSDK.Session>;\n  #clientPromises = new Map<string, Promise<MetorialMcpClient>>();\n\n  constructor(\n    private readonly sdk: MetorialCoreSDK,\n    private readonly init: MetorialMcpSessionInit\n  ) {\n    this.#sessionPromise = this.sdk.sessions.create(init);\n  }\n\n  async getSession(): Promise<MetorialSDK.Session> {\n    return await this.#sessionPromise;\n  }\n\n  async getServerDeployments() {\n    let session = await this.getSession();\n    return session.serverDeployments;\n  }\n\n  async getCapabilities() {\n    let deployments = await this.getServerDeployments();\n\n    let capabilities = await this.sdk.servers.capabilities.list({\n      serverDeploymentId: deployments.map(d => d.id)\n    });\n\n    let serversMap = new Map(capabilities.mcpServers.map(server => [server.id, server]));\n\n    let capabilitiesByDeploymentId = new Map<string, Capability[]>();\n    for (let capability of capabilities.tools) {\n      let server = serversMap.get(capability.mcpServerId);\n      if (!server || !server.serverDeployment) continue;\n\n      let current = capabilitiesByDeploymentId.get(server.serverDeployment.id) || [];\n      current.push({\n        type: 'tool',\n        tool: capability,\n        serverDeployment: server.serverDeployment\n      });\n\n      capabilitiesByDeploymentId.set(server.serverDeployment.id, current);\n    }\n\n    for (let capability of capabilities.resourceTemplates) {\n      let server = serversMap.get(capability.mcpServerId);\n      if (!server || !server.serverDeployment) continue;\n\n      let current = capabilitiesByDeploymentId.get(server.serverDeployment.id) || [];\n      current.push({\n        type: 'resource-template',\n        resourceTemplate: capability,\n        serverDeployment: server.serverDeployment\n      });\n\n      capabilitiesByDeploymentId.set(server.serverDeployment.id, current);\n    }\n\n    let deploymentCapabilities = await Promise.all(\n      deployments.map(async deployment => {\n        let capabilities = capabilitiesByDeploymentId.get(deployment.id);\n        if (!capabilities) capabilities = [];\n\n        // Metorial has auto-discovered capabilities, so we\n        // don't need to do it again.\n        if (capabilities.length) return capabilities;\n\n        // Get a client to manually fetch capabilities using MCP\n        let client = await this.getClient({ deploymentId: deployment.id });\n\n        try {\n          let tools = await client.listTools();\n\n          capabilities.push(\n            ...tools.tools.map(tool => ({\n              type: 'tool' as const,\n              tool: {\n                name: tool.name,\n                description: tool.description,\n                inputSchema: tool.inputSchema\n              },\n              serverDeployment: deployment as any\n            }))\n          );\n        } catch (error) {\n          // Maybe the server doesn't support tool listing.\n        }\n\n        try {\n          let resourceTemplates = await client.listResourceTemplates();\n\n          capabilities.push(\n            ...resourceTemplates.resourceTemplates.map(resourceTemplate => ({\n              type: 'resource-template' as const,\n              resourceTemplate: {\n                name: resourceTemplate.name,\n                description: resourceTemplate.description,\n                uriTemplate: resourceTemplate.uriTemplate\n              },\n              serverDeployment: deployment as any\n            }))\n          );\n        } catch (error) {\n          // Maybe the server doesn't support resource templates.\n        }\n\n        return capabilities;\n      })\n    );\n\n    return Array.from(deploymentCapabilities.values()).flat();\n  }\n\n  async getToolManager() {\n    return MetorialMcpToolManager.fromCapabilities(this, await this.getCapabilities());\n  }\n\n  async close() {\n    await Promise.all(\n      Array.from(this.#clientPromises.values()).map(clientPromise =>\n        clientPromise.then(client => client.close())\n      )\n    );\n  }\n\n  async getClient(opts: { deploymentId: string }) {\n    if (!this.#clientPromises.has(opts.deploymentId)) {\n      let session = await this.getSession();\n\n      this.#clientPromises.set(\n        opts.deploymentId,\n        MetorialMcpClient.create(session, {\n          host: this.mcpHost,\n          deploymentId: opts.deploymentId,\n          clientName: this.init.client?.name,\n          clientVersion: this.init.client?.version\n        })\n      );\n    }\n\n    return await this.#clientPromises.get(opts.deploymentId)!;\n  }\n\n  private get mcpHost() {\n    if (this.sdk._config.mcpHost) return this.sdk._config.mcpHost;\n\n    let host = this.sdk._config.apiHost ?? 'https://api.metorial.com';\n\n    if (host.startsWith('https://api.metorial')) {\n      return host.replace('https://api.metorial', 'https://mcp.metorial');\n    }\n\n    let url = new URL(host);\n    url.port = '3311';\n    return url.toString();\n  }\n}\n"]}